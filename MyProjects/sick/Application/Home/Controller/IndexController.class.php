<?phpnamespace Home\Controller;use Think\Controller;class IndexController extends Controller{    public function __construct()    {        parent::__construct();      //  echo "<script>top.location='weixin://profile/gh_34bd692a9835';</script>";die;       // echo "<script>alert('请您到公众号首页和医生交流'); window.navigate(\"weixin://profile/gh_34bd692a9835\");</script>";die;//        unset($_SESSION['sid']);die;     /*   session('sid','1');*///        session('sid','25');        if(!$_SESSION['sid']){            $this->getUserInfo();        }    }    function curlGet($url,$type="GET"){        $ch = curl_init();        $header = "Accept-Charset: utf-8";        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $type);        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);        curl_setopt($curl, CURLOPT_HTTPHEADER, $header);        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (compatible; MSIE 5.01; Windows NT 5.0)');        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);        curl_setopt($ch, CURLOPT_AUTOREFERER, 1);        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);        $temp = curl_exec($ch);        return $temp;    }    public function getUserInfo(){        $url='https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx5644101e854affee&redirect_uri=http://wx.yiwenzhen.net/index.php/Home/Index/getUserInfo&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect';        $code=I('code');        if(!$code){            header("Location:$url");        }        $api_url = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx5644101e854affee&secret=5c3972dd5a386dc5f8af58e662a2b891&code='.$code.'&grant_type=authorization_code';        $token= $this->curlGet($api_url);        $access_token=json_decode($token)->access_token;        $openid = json_decode($token)->openid;        $pull_url ='https://api.weixin.qq.com/sns/userinfo?access_token='.$access_token.'&openid='.$openid.'&lang=zh_CN';        $user_xin=$this->curlGet($pull_url,'POST');        $user = json_decode($user_xin);        if(!empty($user->openid)){            //判断 用户表是否存在 此openid            $_SESSION['openid'] = $user->openid;            $molde = M('ty_sick');            $res = $molde->where('openid="'.$user->openid.'"')->find();            if(!$res) {                $user_res = M('ty_doctor')->where('openid="'.$user->openid.'"')->find();                if($user_res){                    $this->redirect('Doctor/index','',1,"<script>alert('您已经注册为医生，不能再次注册为用户');</script>");                }                $date['username'] = $user->nickname;                $date['openid'] = $user->openid;                $date['sex'] = $user->sex == 0 ? 1 : $user->sex;                $date['address'] = $user->city;                $date['icon'] = $user->headimgurl;                $row=$molde->add($date);                if($row){                    $url=$this->appUrl . '/Home/Index/index/userId/'.$row.'.html';                    Vendor('phpqrcode.phpqrcode');                    $errorCorrectionLevel =intval(3) ;//容错级别                    $matrixPointSize = intval(20);//生成图片大小                    //生成二维码图片                    //echo $_SERVER['REQUEST_URI'];                    $path ='./Public/QRCode/'; // 图片输出路径                    $qrcodeName=time().$row;                    mkdir ( $path );                    $object = new \QRcode();                    $object->png($url, $path.''.$qrcodeName.'.png', $errorCorrectionLevel, $matrixPointSize, 2,$saveandprint=true);                    M('ty_sick')->where('id='. $row)->data(array('qrcode'=>$path.''.$qrcodeName.'.png'))->save();                    $_SESSION['sid'] = $row;                    $this->redirect('Index/index');                }else{                    $this->redirect('Index/getUserInfo');                }            }else{                $_SESSION['sid'] = $res['id'];                $this->redirect('Index/index');            }        }    }    // 首页    public function index()    {        $category = M('ty_category');        $categorydata = $category->order('id asc')->select();        $doctor = M('ty_doctor');        $doctordata = $doctor->join('ty_category on ty_doctor.office = ty_category.id')->field('ty_doctor.*,ty_category.catname')->select();            /*if(IS_GET){                $shijian = $_GET('sj');                if($shijian == 'shijian'){    //                var_dump($shijian);die;                    $doctordata = M('ty_doctor')->order('reply_time desc')->select();                }            }*/        if(IS_POST){            $rank = I('rank');            if($rank){                $doctordata = $doctor->where(array('rank'=> $rank))->select();            }            $username = I('username');            if($username){                $map['username'] = array('like',"{$username}%");                $doctordata = $doctor->where($map)->select();            }            $shijian = I('shijian');            if($shijian == '1'){                $doctordata = $doctor->order('reply_time desc')->select();            }        }        $this->assign('categorydata',$categorydata);        $this->assign('doctordata',$doctordata);        $this->display();    }    //副首页    public function index_state(){        $id = I('id');        $doctor = M('ty_doctor');//        $doctordata = $doctor->join('ty_category on ty_doctor.office = ty_category.id')->field('ty_doctor.*,ty_category.catname')->where(array('office'=> $id))->select();        $doctordata = $doctor->where(array('office'=> $id))->select();//        var_dump($doctordata);die;        if(IS_POST){            $rank = I('rank');            if($rank){                $doctordata = $doctor->where(array('rank'=> $rank,'office'=>$id))->select();            }            $username = I('username');            if($username){                $map['username'] = array('like',"{$username}%");                $doctordata = $doctor->where($map)->select();            }            $shijian = I('shijian');            if($shijian){                $doctordata = $doctor->where(array('office'=> $shijian))->order('reply_time')->select();            }        }        foreach($doctordata as $k=>&$v){             $v['office'] = M('ty_category')->where(array('id'=> $v['office']))->getField('catname');        }//        var_dump($doctordata);die;        $category = M('ty_category');        /*$renshu = M('ty_service')->where(array('id'=>$id))->count();        $this->assign('renshu',$renshu);*/        $data = $category->order('id asc')->select();        $this->assign('doctordata',$doctordata);        $this->assign('data',$data);        if($shijian){            $this->assign('id',$shijian);        }else{            $this->assign('id',$id);        }        $this->display();    }    //医生详细    public function doctor_detail(){        $sid = session('sid');        $id = I('id');        $sick = M('ty_sick');        $info = $sick->where(array('id'=> $sid))->getField('attention');        $arr =  json_decode($info,true);        $arr =  array_unique($arr);        if(in_array($id,$arr)){            $type = 1;            $this->assign('type',$type);        }else{            $type = 2;            $this->assign('type',$type);        }        $doctor = M('ty_doctor');        $data = $doctor->where(array('id'=> $id))->find();        $map['d_id'] = $data['id'];        $map['grade'] = array('gt',3);        $aaa = M('ty_comment')->where($map)->count();        $data['haoping'] = $aaa;        if(IS_POST){            $type = I('type');            $did = I('did');            $doctordata   = M('ty_doctor')->where(array('id'=> $did))->field('username,office,orderprice')->find();            $servicedata['type'] = $type;            $servicedata['price'] = $doctordata['orderprice'];            $servicedata['servetime'] = time();            $servicedata['username'] = $doctordata['username'];            $servicedata['office'] = M('ty_category')->where(array('id'=>$doctordata['office']))->getField('catname');            $servicedata['s_id'] = $sid;            $servicedata['d_id'] = $did;            $servicedata['is_pay'] = 1;            $servicedata['is_status'] = 1;            /*好友部分*/            $acceptsick_id = M('ty_doctor')->where(array('id'=> $did))->getField('acceptsick_id');            $acceptsick_id_arr = json_decode($acceptsick_id,true);            $acceptsick_id_arr = array_unique($acceptsick_id_arr);            $acceptsick_id_arr[] = (int)$_SESSION['sid'];            $acceptsick_arr = json_encode($acceptsick_id_arr);            $doctor->where(array('id'=> $did))->setField('acceptsick_id',$acceptsick_arr);            /*好友部分*/            if($type == 2){                $_SESSION['about_order']=$servicedata;                $this->redirect('Index/order');die;            }else{                $_SESSION['image_text_order']=$servicedata;                $this->redirect('Index/pay_immediately');            }        }        $category = M('ty_category');        $data['office'] = $category->where(array('id'=> $data['office']))->getField('catname');        $comment = M('ty_comment');        $commentdata = $comment->where(array('d_id'=> $id))->field('s_id,content,addtime')->order("addtime desc")->select();        foreach($commentdata as &$v){            $v['s_id'] = M('ty_sick')->where(array('id'=>$v['s_id']))->field('username,sex,address,icon')->find();        }        $service = M('ty_doctor');        $servicedata = $service->where(array('id'=> $id))->field('freeconsult,is_orderstatus,is_picture')->find();        $this->assign('servicedata',$servicedata);        $orderconsult = M('ty_orderconsult');        $orderconsultdata = $orderconsult->where(array('d_id'=> $id))->getField('price');        $this->assign('orderconsultdata',$orderconsultdata);        $this->assign('did',$id);        $this->assign('commentdata',$commentdata);        $this->assign('doctordata',$data);        $this->display();    }    public function ajax(){            $did = I('id');            if($did){                $sid = $_SESSION['sid'];                $doctor = M('ty_doctor');                $sick_id  = $doctor->where(array('id'=> $did))->getField('sick_id');                $sick_id_arr = json_decode($sick_id,true);                $sick_id_arr = array_unique($sick_id_arr);                $sick_id_arr[] = (int)$sid;                $sick_arr = json_encode($sick_id_arr);                $doctor->where(array('id'=> $did))->setField('sick_id',$sick_arr);//                var_dump($sick_arr);die;                $info = M('ty_sick')->where(array('id'=> $_SESSION['sid']))->getField('attention');                $arr =  json_decode($info,true);                $arr =  array_unique($arr);                if(in_array($did,$arr)){                    $k=array_search($did,$arr);                    unset($arr[$k]);                    $arr1 =  json_encode($arr);                   M('ty_sick')->where(array('id'=> $_SESSION['sid']))->setField('attention',$arr1);                }else{                    $arr[] = (int)$did;                    $arr1 =  json_encode($arr);                     M('ty_sick')->where(array('id'=> $_SESSION['sid']))->setField('attention',$arr1);                }                    $this->redirect('Index/doctor_detail',array('id'=>$did));            }else{                $this->redirect('Index/index');            }    }    //  立即咨询    public function pay_immediately(){        $doctordata = M('ty_doctor')->where(array('id'=>$_SESSION['image_text_order']['d_id']))->field('tuwenpirce,orderprice,image')->find();        if(IS_POST){            $sickphone = I('sickphone');            $_SESSION['image_text_order']['sickphone']=$sickphone;            $_SESSION['image_text_order']['addtime']=time();            $_SESSION['image_text_order']['price']=$_POST['price'];            $servicedata=M('ty_service')->create($_SESSION['image_text_order']);            $result = M('ty_service')->add($servicedata);            if($result){                $this->redirect('Index/pay',array('id'=> $result));die;            }        }        $this->assign('payprice',$doctordata);        $this->assign('doctordata',$_SESSION['image_text_order']);        $this->display();    }    function pay(){        $id=I('id');        $price=M('ty_service')->where(array('id'=>$id))->getField('price');        $price=0.01;        if($price && $id){            $_SESSION['server_id']=$id;            $_SESSION['server_price']=$price;            $_SESSION['type']='1';            $this->redirect('Pay/index');        }else{            $this->error('参数错误');        }    }    //支付成功    public function payment_success(){        if($_SESSION['type'] == 1){            $id=$_SESSION['server_id'];            $_SESSION['server_id']='';            $_SESSION['server_price']='';            $list= M('ty_service')->where(array('id'=>$id))->find();            if($list['is_pay'] != 2 || $list["is_status"] !=1){                $this->redirect('Index/current_service','',1,"<script>alert('支付失败，请重新确认')</script>");            }            if($list['type']==1){                $this->redirect('Menu/index');            }            $this->assign('serviceId',$id);            $this->assign('type',$list['type']);            $this->display();        }else if($_SESSION['type'] == 2){            $id=$_SESSION['server_id'];            $_SESSION['server_id']='';            $_SESSION['server_price']='';            $list= M('ty_mind')->where(array('id'=>$id))->find();            if($list['is_pay'] == 0){                $this->redirect('Index/my_doctor','',1,"<script>alert('支付失败，请重新确认')</script>");            }else{                $this->redirect('Newuser/Send_the_mind_money');            }        }else{            $_SESSION['server_id']='';            $_SESSION['server_price']='';            $this->redirect('Index/my_content');        }    }    // 咨询信息    public function quick_consultation(){        $id = session('sid');        $serviceId = I('get.id');        $d_id  = M('ty_service')->where(array('id'=>$serviceId))->getField('d_id');        if(IS_GET){           $type = M('ty_service')->where(array('id'=>$serviceId))->getField('type');           if($type == 2){               $this->redirect('Index/order',array('id'=> $serviceId));die;           }        }        if(IS_POST) {            $abc = M('ty_doctor')->where(array('id'=> $d_id))->setInc('servernum');//            echo M('ty_doctor')->getLastSql();die;//            var_dump($abc);die;            $servicedata = M('ty_service')->where(array('id' => $serviceId))->field('s_id,d_id')->find();            $data['f_id'] = $serviceId;            $data['s_id'] = $servicedata['s_id'];            $data['d_id'] = $servicedata['d_id'];            $data['age'] = $_POST['age'];            $data['sex'] = $_POST['sex'];            $data['content'] = $_POST['content'];            $data['address'] = $_POST['sheng'] . $_POST['shi'];            $data['addtime'] = time();            $result = M('ty_consult')->add($data);            if ($result) {                 $this->redirect('Menu/index');                // $this->redirect('Index/current_service','',1,"<script>alert('提交成功')</script>");die;            }else{                $this->redirect('Index/quick_consultation','',1,"<script>alert('提交失败')</script>");            }        }        $this->display();    }    //预约门诊    public function order(){        $id = session('sid');        $d_id  = $_SESSION['about_order']['d_id'];        if(IS_POST){            M('ty_doctor')->where(array('id'=> $d_id))->setInc('servernum');            $_SESSION['aserver_content']=$_POST;            $this->redirect('Index/select_time');        }        $this->assign('d_id',$d_id);        $this->display();    }    //当前服务    public function current_service(){        $sid = session('sid');        $info =  M()->query("SELECT * FROM ty_service  WHERE is_pay IN (1,2,3) AND s_id=$sid AND is_status IN (1,2) ORDER BY id DESC");       // $info =  $service->where(array('s_id'=> $sid,'is_status'=> 1))->select();        foreach($info as $k=>$v){            if($v['is_status'] == 4){                unset($info[$k]);            }        }     // print_r($info);die;        $this->assign('info',$info);        $this->display();    }    //意见反馈    public function feedback(){        $id = session('sid');        $idea = M('ty_idea');        if(IS_POST){            $post = $idea->create(I('post.'));            $post['s_id'] = $id;            $post['sickname'] = M('ty_sick')->where(array('id'=>$id))->getField('username');            $post['addtime'] = time();            $result = $idea->add($post);            if($result){                $this->redirect('Index/my_content','',1,"<script>alert('提交成功')</script>");            }else{                $this->redirect('Index/feedback','',1,"<script>alert('提交失败')</script>");            }        }        $this->display();    }    //个人中心    public function my_content(){        $id = session('sid');        $sick = M('ty_sick');        $sickusername = $sick->where(array('id'=> $id))->field('id,username,icon')->find();        $this->assign('sickusername',$sickusername);        $this->display();    }    // 个人信息    public function revise_info(){        $sid = session('sid');        $sick = M('ty_sick');        $sickdata = $sick->where(array('id'=> $sid))->field('sex,userage,phonenum,username')->find();        if(IS_POST){            $data = $sick->create(I('post.'),2);            $result = $sick->where(array('id'=> $sid))->save($data);            if($result){//                $this->success('修改成功',U("Index/revise_info"),1);die;                $this->redirect('Index/my_content','',1,"<script>alert('修改成功')</script>");            }else{                $this->redirect('Index/revise_info','',1,"<script>alert('修改失败')</script>");            }        }        $this->assign('sickdata',$sickdata);        $this->display();    }    //我的医生    public function my_doctor(){        $id = session('sid');        $service = M('ty_service');        $did_all = $service->where(array('s_id'=> $id))->group('d_id')->getField('d_id',true);        $sick = M('ty_sick');        $doctor =  M('ty_doctor');        $attention = $sick->where(array('id'=> $id))->getField('attention');        $attention_did = json_decode($attention,true);        $attention_did=!empty($attention_did)?$attention_did:array();        $did_all=!empty($did_all)?$did_all:array();        $result = array_merge( $attention_did ,$did_all);        $result = array_unique($result);        $did_str = implode(',',$result);        if($did_str){            $map['id'] = array('in',$did_str);            $doctordata =$doctor->where($map)->select();        }else{            $doctordata=array();        }        $this->assign('doctordata',$doctordata);        $this->display();    }    // 删除医生信息    public function del_doctor(){        $doctorId  =  I('did');        if(IS_POST){//            $()        }    }    public function close(){        $id=I('id');        if(!$id){            echo '操作失败，非法参数。';die;        }        M('ty_service')->where(array('id'=>$id))->data(array('is_status'=>2))->save();        $this->display();    }    //服务历史    public function service_history(){        $id = session('sid');        $service = M('ty_service');        $map['is_status'] = array('eq', 3);        $map['s_id'] = $id;        $service_data =$service->where($map)->order('servetime desc')->select();        $this->assign('info',$service_data);        $this->display();    }    //我的关注    public function my_follower(){        $id = session('sid');        $sick = M('ty_sick');        $sickdata = $sick->where(array('id'=>$id))->getField('attention');        $sickdata  =  json_decode($sickdata,true);        $sickdata = array_unique($sickdata);        $doctor = M('ty_doctor');        $doctordata = array();        foreach($sickdata as $k=>$v){            $arr = $doctor->where(array('id'=>$v))->field('username,image')->find();            if(!empty($arr)){                $doctordata[] = $arr;            }        }        $this->assign('doctordata',$doctordata);        $this->display();    }    //我的健康    public function my_health(){        $sid = session('sid');        $sick = M('ty_sick');//        $sickdata = $sick->where(array('id'=> $sid))->field('phonenum,username,sex,userage,height,weight,marriage')->find();        $sickdata = $sick->where(array('id'=> $sid))->find();        if(IS_POST){            $data = $sick->create(I('post.'));            $result = $sick->where(array('id'=> $sid))->save($data);            if($result){                // $this->success('修改成功',U("Index/my_health"),1);die;                $this->redirect('Index/my_health','',1,"<script>alert('提交成功')</script>");            }else{                $this->redirect('Index/my_health','',1,"<script>alert('提交失败')</script>");            }        }        $this->assign('info',$sickdata);        $this->display();    }    //我的爱好    public function habit(){        $sid = session('sid');        $sick = M('ty_sick');        $sickdata = $sick->where(array('id'=> $sid))->find();//        var_dump($sickdata);die;        if(IS_POST){            $data = $sick->create(I('post.'));            $result = $sick->where(array('id'=> $sid))->save($data);            if($result){                $this->redirect("Index/habit",'',1,"<script>alert('提交成功')</script>");            }else{                $this->redirect('Index/habit','',1,"<script>alert('提交失败')</script>");            }        }        $this->assign('sickdata',$sickdata);        $this->display();    }    //个人积分    public function my_integral(){        $this->display();    }    //我的二维码    public function my_Orcode(){        $id = session('sid');        $sick = M('ty_sick');        $sickdata = $sick->where(array('id'=> $id))->field('username,icon,qrcode')->find();        $this->assign('doctordata',$sickdata);        $this->display();    }    //医生评价    public function evaluate(){        $sid = session('sid');        $get =  I('get.');        $id = I('fid');//        $did = I('d_id');        $doctorobj = M('ty_doctor');        $serviceobj = M('ty_service');        $dd_id = $serviceobj->where(array('id'=> $id))->field('d_id')->find();        $doctordata = $doctorobj->where(array('id'=> $dd_id['d_id']))->find();        $doctordata['office'] = M('ty_category')->where(array('id'=>$doctordata['office']))->getField('catname');        $comment = M('ty_comment');        if(IS_POST){            $data['f_id'] = $_POST['fid'];            $rs = M('ty_service')->where(array('id'=>$data['f_id']))->setField('is_status',3);            $data['d_id'] = $_POST['did'];            $data['s_id'] = session('sid');            $data['grade'] = $_POST['xingxing'];            $data['content'] = $_POST['pingjia'].$_POST['content'];            $data['addtime'] = time();            $result = $comment->add($data);            if($result){                $pingfen = M('ty_comment')->where(array('d_id'=> $_POST['did']))->avg('grade');                $pingfen = round($pingfen,2);                $ct = $comment->where(array('d_id'=>$_POST['did']))->count();                $data = array('zscore'=> $pingfen,'evaluatenum'=> $ct);                M('ty_doctor')->where(array('id'=> $_POST['did']))->setField($data);                $this->redirect('Index/service_history','',1,"<script>alert('评价成功')</script>");die;            }else{                if(!$rs){                    $this->redirect('Index/current_service','',1,"<script>alert('评价失败')</script>");die;                }                $this->redirect('Index/current_service','',1,"<script>alert('评价失败')</script>");die;            }        }        $this->assign('fid',$id);        $this->assign('get',$get);        $this->assign('doctordata',$doctordata);        $this->display();    }    //评论    public function evaluate_page(){        $sid = session('sid');        $id = I('get.did');//        $did = I('did');        $comment = M('ty_comment');        $comment_doctor = $comment->where(array('d_id'=> $id))->order('addtime desc')->select();        foreach($comment_doctor as &$v){            $v['s_id'] = M('ty_sick')->where(array('id'=> $sid))->field('username,sex,address,icon')->find();        }//        var_dump($comment_doctor);die;        $this->assign('comment',$comment_doctor);        $this->display();    }    //评价成功    public function success_evalute(){        $this->display();    }    //第三方意见    public function Third_party_opinions(){        $fid = I('fid');        $thirdparty = M('ty_thirdparty');        $info = $thirdparty->where(array('f_id'=> $fid))->select();        foreach($info as &$v){            $v['d_id'] = M('ty_doctor')->where(array('id'=>$v['d_id']))->getField('username');        }//        var_dump($info);die;        $this->assign('info',$info);        $this->display();    }    // 预约时间页面    public function select_time(){        if(IS_POST){            $date=I('date');            $time=I('time');          //  print_r($_POST);die;            //echo strtotime($date);die;            if(!$time || !$date){                $this->redirect('Index/select_time','',1,"<script>alert('修改失败');</script>");            }            if(strtotime($date) <= strtotime('11:30')){                $set_map['ordertime']=1;                $begin=date('Y-m').'-'.$time.' '.'09:30:00';                $end=date('Y-m').'-'.$time.' '.'11:30:00';                $ser_map['ordertime']=array('between',"$begin,$end");            }else if(strtotime($date) <= strtotime('14:30')){                $set_map['ordertime']=2;                $begin=date('Y-m').'-'.$time.' '.'11:31:00';                $end=date('Y-m').'-'.$time.' '.'14:30:00';                $ser_map['ordertime']=array('between',"$begin,$end");            }else{                $set_map['ordertime']=3;                $begin=date('Y-m').'-'.$time.' '.'14:31:00';                $end=date('Y-m').'-'.$time.' '.'17:00:00';                $ser_map['ordertime']=array('between',"$begin,$end");            }            $ser_map['type']=2;            $ser_map['is_pay']=2;            $ser_map['d_id']=$_SESSION['about_order']['d_id'];            $people_num=M('ty_service')->where($ser_map)->count();            $subscribe=date('Y-m').'-'.$time.' '.$date.':00';            $day=date('N',strtotime($subscribe));            $set_map['d_id']=$_SESSION['about_order']['d_id'];            $set_map['week']=$day;            $orderset=M('ty_orderset')->where($set_map)->find();            if(!$orderset){                $this->redirect('Index/select_time','',1,"<script>alert('当前时间段不支持预约');</script>");            }            if($people_num >= $orderset['numpeople']){                $this->redirect('Index/select_time','',1,"<script>alert('当前时间段预约人数已满,请重新选择时间');</script>");            }            $about_order=M('ty_service')->create($_SESSION['about_order']);            $about_order['is_status']=1;            $about_order['is_pay']=1;            $about_order['servetime']=strtotime(date('Y-m').'-'.$time.' '.$date.':00');            $about_order['addtime'] = time();            $row=M('ty_service')->data($about_order)->add();            if(!$row){                $this->redirect('Index/index','',1,"<script>alert('预约失败');</script>");            }            $data['f_id'] = $row;            $data['s_id'] = $about_order['s_id'];            $data['d_id'] = $about_order['d_id'];            $data['age'] = $_SESSION['aserver_content']['age'];            $data['sex'] = $_SESSION['aserver_content']['sex'];            $data['content'] =$_SESSION['aserver_content']['depict'];            $data['address'] = $_SESSION['aserver_content']['sheng'] . $_SESSION['aserver_content']['shi'];            $data['province'] = $_SESSION['aserver_content']['sheng'];            $data['city'] = $_SESSION['aserver_content']['shi'];            $data['is_status'] = 1;            $data['addtime'] = time();            $num=M('ty_consult')->data($data)->add();            unset($_SESSION['about_order']);            unset($_SESSION['aserver_content']);            if($row && $num){                $this->redirect('Index/pay',array('id'=> $row));die;               // $this->redirect('Index/current_service');            }else{                $this->redirect('Index/index','',1,"<script>alert('预约失败');</script>");            }        }else{            $result = M('ty_orderset')->where(array('d_id'=>$_SESSION['about_order']['d_id']))->select();            $week= date('N',time());            $str_time='';            foreach($result as $k=>$v){                if($v['week'] < $week){                    $result[$k]['date']=date('Y/m/d',time()-(($week-$v['week'])*86400));                }                else if($v['week'] > $week){                    $result[$k]['date']=date('Y/m/d',time()+(($v['week']-$week)*86400));                }else{                    $result[$k]['date']=date('Y/m/d',time());                }                if($v['week']>= $week){                    $list[$k]=$result[$k];                    $str_time=$str_time.$result[$k]['date'].',';                }            }            $this->assign('list',$list);            $this->assign('str_time',$str_time);            $this->assign('result',$result);            $this->display();        }    }    //图文咨询历史    public function Chat_record(){        $sid = session('sid');        $tuwen = M('ty_service')->where(array('s_id'=> $sid,'type'=> '1'))->field('id,username,office,addtime,d_id')->select();        foreach($tuwen as $k=>&$v){             $tuwen[$k]['content'] = M('ty_consult')->where(array('f_id'=>$v['id']))->getField('content');        }//        var_dump($tuwen);die;        $this->assign('info',$tuwen);        $this->display();    }    //预约咨询历史    public function Chat_record_two(){        $sid = session('sid');        $yuyue = M('ty_service')->where(array('s_id'=> $sid,'type'=> '2'))->field('id,username,office,addtime')->select();        foreach($yuyue as $k=>&$v){            $tuwen[$k]['content'] = M('ty_consult')->where(array('f_id'=>$v['id']))->getField('content');//            $v['id'] = M('ty_consult')->where(array('f_id'=>$v['id']))->getField('content');        }//        var_dump($yuyue);die;        $this->assign('info',$yuyue);        $this->display();    }    // 聊天记录页面    public function chat(){//        $sid = session('sid');        $fid = I('fid');        $info = M('ty_consult')->where(array('f_id'=> $fid))->field('id,d_id,s_id,content,reply_type')->select();        $doctor = M('ty_doctor');        $sick = M('ty_sick');        foreach($info as $k=>&$v){            $v['d_id'] =  $doctor->where(array('id'=>$v['d_id'] ))->getField('image');            $v['s_id'] =  $sick->where(array('id'=>$v['s_id'] ))->getField('icon');        }        $this->assign('info',$info);        $this->display();    }    /*聊天设置*/    public function setchat(){//        $sid = session('sid');        $get = I('get.');        $service = M('ty_service');        if($get['guan'] == 1){           $result =  $service->where(array('id'=>$get['fid']))->setField('u_reply_status',2);        }elseif($get['guan'] == 2){            $result = $service->where(array('id'=>$get['fid']))->setField('u_reply_status',1);        }elseif($get['guan'] == 3){            $result =  $service->where(array('id'=>$get['fid']))->setField('is_status',2);        }        if($result){            $this->redirect("Index/current_service",'',1,"<script>alert('操作成功')</script>");        }else{            $this->redirect("Index/current_service",'',1,"<script>alert('操作失败')</script>");        }    }}