<?php/** * wechat php test *///define your tokendefine("TOKEN", "taiyou");$wechatObj = new wechatCallbackapiTest();require_once('mysql.php');if (!isset($_GET['echostr'])) {    $wechatObj->responseMsg();}else{    $wechatObj->valid();}class wechatCallbackapiTest{    public function valid()    {        $echoStr = $_GET["echostr"];        if($this->checkSignature()){            echo $echoStr;            exit;        }    }    public function responseMsg()    {        $postStr = $GLOBALS["HTTP_RAW_POST_DATA"];        //extract post data        if (!empty($postStr)){            /* libxml_disable_entity_loader is to prevent XML eXternal Entity Injection,               the best way is to check the validity of xml by yourself */            libxml_disable_entity_loader(true);            $postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);            $fromUsername = $postObj->FromUserName;            $dbname ='yiwenzhen';            /*接着调用mysql_connect()连接服务器*/            $link = @mysql_connect("localhost","yiwenzhen","ZX4lcjJjWG1aXHgA");            if(!$link) {                $content = "创建数据库有误";                $result = $this->transmitText($postObj, $content);                echo  $result;die;            }            /*连接成功后立即调用mysql_select_db()选中需要连接的数据库*/            if(!mysql_select_db($dbname)) {                $content = "链接数据库有误";                $result = $this->transmitText($postObj, $content);                echo  $result;die;            }else{                mysql_query('set names utf8');//确定字符编码                $sql="SELECT * FROM ty_sick WHERE openid='$fromUsername'";               // $list=_select_data($sql);                $content = "这是个文本消息";                $result = $this->transmitText($postObj, $content);                echo  $result;die;            }die;            $toUsername = $postObj->ToUserName;            $MsgType = $postObj->MsgType;            $keyword = trim($postObj->Content);            $time = time();            switch ($MsgType)            {                case "event":                    $result = $this->receiveEvent($postObj);                    break;                case "text":                    $result = $this->receiveText($postObj);                    break;                case "image":                    $result = $this->receiveImage($postObj);                    break;                case "location":                    $result = $this->receiveLocation($postObj);                    break;                case "voice":                    $result = $this->receiveVoice($postObj);                    break;                case "video":                    $result = $this->receiveVideo($postObj);                    break;                case "link":                    $result = $this->receiveLink($postObj);                    break;                default:                    $result = "unknown msg type: ".$MsgType;                    break;            }            echo $result;        }else {            echo "";            exit;        }    }    //验证    private function checkSignature()    {        // you must define TOKEN by yourself        if (!defined("TOKEN")) {            throw new Exception('TOKEN is not defined!');        }        $signature = $_GET["signature"];        $timestamp = $_GET["timestamp"];        $nonce = $_GET["nonce"];        $token = TOKEN;        $tmpArr = array($token, $timestamp, $nonce);        // use SORT_STRING rule        sort($tmpArr, SORT_STRING);        $tmpStr = implode( $tmpArr );        $tmpStr = sha1( $tmpStr );        if( $tmpStr == $signature ){            return true;        }else{            return false;        }    }    //接收图片消息    private function receiveImage($object)    {        $content = array("MediaId"=>$object->MediaId);        $result = $this->transmitImage($object, $content);        return $result;    }    //回复图片消息    private function transmitImage($object, $imageArray)    {        $itemTpl = "<Image>                    <MediaId><![CDATA[%s]]></MediaId>                     </Image>";        $item_str = sprintf($itemTpl, $imageArray['MediaId']);        $xmlTpl = "<xml>                    <ToUserName><![CDATA[%s]]></ToUserName>                    <FromUserName><![CDATA[%s]]></FromUserName>                    <CreateTime>%s</CreateTime>                    <MsgType><![CDATA[image]]></MsgType>                    $item_str                    </xml>";        $result = sprintf($xmlTpl, $object->FromUserName, $object->ToUserName   , time());        return $result;    }    //接收事件消息    private function receiveEvent($object)    {        $content = "";        switch ($object->Event)        {            case "subscribe":                $content = "欢迎关注泰友公众号";                $content .= (!empty($object->EventKey))?("\n来自二维码场景 ".str_replace("qrscene_","",$object->EventKey)):"";                break;            case "unsubscribe":                $content = "取消关注";                break;            case "SCAN":                $content = "扫描场景 ".$object->EventKey;                break;            case "CLICK":                switch ($object->EventKey)                {                    case "COMPANY":                        $content = array();                        $content[] = array("Title"=>"多图文1标题", "Description"=>"", "PicUrl"=>"http://discuz.comli.com/weixin/weather/icon/cartoon.jpg", "Url" =>"http://m.cnblogs.com/?u=txw1958");                        break;                    default:                        $content = "点击菜单：".$object->EventKey;                        break;                }                break;            case "LOCATION":                $content = "上传位置：纬度 ".$object->Latitude.";经度 ".$object->Longitude;                break;            case "VIEW":                $content = "跳转链接 ".$object->EventKey;                break;            case "MASSSENDJOBFINISH":                $content = "消息ID：".$object->MsgID."，结果：".$object->Status."，粉丝数：".$object->TotalCount."，过滤：".$object->FilterCount."，发送成功：".$object->SentCount."，发送失败：".$object->ErrorCount;                break;            default:                $content = "receive a new event: ".$object->Event;                break;        }        if(is_array($content)){            if (isset($content[0])){                $result = $this->transmitNews($object, $content);            }else if (isset($content['MusicUrl'])){                $result = $this->transmitMusic($object, $content);            }        }else{            $result = $this->transmitText($object, $content);        }        return $result;    }    //接收文本消息    private function receiveText($object)    {        $keyword = trim($object->Content);        //多客服人工回复模式       /* if (strstr($keyword, "您好") || strstr($keyword, "你好") || strstr($keyword, "在吗")){            $result = $this->transmitService($object);        }        //自动回复模式        else{            if (strstr($keyword, "文本")){                $content = "这是个文本消息";            }else if (strstr($keyword, "单图文")){                $content = array();                $content[] = array("Title"=>"单图文标题",  "Description"=>"单图文内容", "PicUrl"=>"http://discuz.comli.com/weixin/weather/icon/cartoon.jpg", "Url" =>"http://m.cnblogs.com/?u=txw1958");            }else if (strstr($keyword, "图文") || strstr($keyword, "多图文")){                $content = array();                $content[] = array("Title"=>"多图文1标题", "Description"=>"", "PicUrl"=>"http://discuz.comli.com/weixin/weather/icon/cartoon.jpg", "Url" =>"http://m.cnblogs.com/?u=txw1958");                $content[] = array("Title"=>"多图文2标题", "Description"=>"", "PicUrl"=>"http://d.hiphotos.bdimg.com/wisegame/pic/item/f3529822720e0cf3ac9f1ada0846f21fbe09aaa3.jpg", "Url" =>"http://m.cnblogs.com/?u=txw1958");                $content[] = array("Title"=>"多图文3标题", "Description"=>"", "PicUrl"=>"http://g.hiphotos.bdimg.com/wisegame/pic/item/18cb0a46f21fbe090d338acc6a600c338644adfd.jpg", "Url" =>"http://m.cnblogs.com/?u=txw1958");            }else if (strstr($keyword, "音乐")){                $content = array();                $content = array("Title"=>"最炫民族风", "Description"=>"歌手：凤凰传奇", "MusicUrl"=>"http://121.199.4.61/music/zxmzf.mp3", "HQMusicUrl"=>"http://121.199.4.61/music/zxmzf.mp3");            }else{                $content = date("Y-m-d H:i:s",time())."\n".$object->FromUserName."\n技术支持 aizhuyishi";            }            if(is_array($content)){                if (isset($content[0]['PicUrl'])){                    $result = $this->transmitNews($object, $content);                }else if (isset($content['MusicUrl'])){                    $result = $this->transmitMusic($object, $content);                }            }else{                $result = $this->transmitText($object, $content);            }        }*/        $content = "这是个文本消息".$object->FromUserName;        $result = $this->transmitText($object, $content);        return $result;    }    //回复文本消息    private function transmitText($object, $content)    {        $xmlTpl = "<xml>            <ToUserName><![CDATA[%s]]></ToUserName>            <FromUserName><![CDATA[%s]]></FromUserName>            <CreateTime>%s</CreateTime>            <MsgType><![CDATA[text]]></MsgType>            <Content><![CDATA[%s]]></Content>            </xml>";        $result = sprintf($xmlTpl, $object->FromUserName, $object->ToUserName, time(), $content);        return $result;    }}?>