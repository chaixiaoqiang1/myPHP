本文档是关于commands文件下一些脚本的说明：

1：从服务器上读取游戏打印过来的.时间戳格式的文件 导入到数据库中的脚本
		目前都属于slave端脚本，这种类型的脚本格式比较统一，脚本中都有 常量 FILE_KEY 是要导入的文件名称，
	比较早期的这类脚本数据库中的表都是开服时脚本自动建的，比如 ImportExpLogIntoDB、
	ImportCreatePlayerLogIntoDB等，从ImportMingGeLogIntoDB开始以后的这类脚本，数据表都是直接在脚本中建的。
	这类脚本测试没问题后直接挂在ImportLogDataIntoDB这个脚本下即可，服务器会在每个整10分去调ImportLogDataIntoDB这个脚本，
	然后通过ImportLogDataIntoDB调用挂在其下的每个脚本。这类脚本导入的时候会在file_flag表中记录本次导入的最后一个文件的文件名，
	下次运行的时候会将上次已经导入过的文件移到.bak文件（数据库.bak，如1.1.bak）下。


	比较特殊的有：
	1）经济日志脚本
		因为经济日志查询关注的都是元宝铜钱等的变化值，所以经济日志脚本都会在
	导入数据库前需要计算这些字段的差值字段(diff_字段)存到数据库中，以方便查询数据。
	女神之剑和德扑使用早期的脚本ImportEconomyLogIntoDB。
	风流三国使用ImportFLSGEconomyLogIntoDB脚本，这个脚本在导数据时对表进行了纵向切割，
	分别是log_economy、log_economy_extra、log_economy_third三个表，
	log_economy表中导入文件中前面的若干字段，会将读取出的数据全部导入。
	后面两个表只导入diff_字段不为0的数据，所以表的数据量不是太大，
	如果经济日志增加了字段可以更新log_economy_third表的结构导入新增加的字段。

	2）风流三国神树大乱斗脚本
		这个脚本是导入几个跨服活动的期间产生的日志，会在活动开启时间段内
	每天的0点左右会打印一次日志，因为只有主服打印的日志是有意义的，
	所以只要导入主服的有意义的日志即可，从服的一些不标准的日志直接移到.bak下不进行导入。

	*3）RemoveLogFileIntoBak脚本
		这个脚本不是导日志文件数据到数据库的脚本，是相关的一个脚本。由于有很多游戏日志运营后台这边暂时没有导入，
	这部分没有导入脚本的日志文件存放在目录下不方便导入其他日志也占用空间，所以直接移到.bak文件夹下。
		这个脚本中会加入游戏对应的要导入的日志类型，然后将不导入的其他日志移到.bak文件夹下吗，
	所以当一个游戏要用到某个日志数据的时候，在增加新脚本时，要在这个脚本里将该日志加入到对应的游戏下。
	有时候可能希望将一段时间之前的数据也导入，这时则需要运维将最近一段时间之内的该日志文件先从.bak文件夹下移出来再进行导入。
	或者运维移出这个文件如果不方便的话，可以再写一个脚本将需要的日志文件移出来。一定要先改这个脚本，再移出日志文件后再运行新脚本，
	否则前面的数据将不会导入数据库中。


2：统计数据后将统计结果以邮件的形式发送到特定的邮箱的脚本
	1）日报脚本DayReport
		每天凌晨会跑一遍日报脚本，统计游戏的留存、收入、等级趋势、登录、支付渠道数据，
	没有日志库库的游戏只需要统计收入和支付渠道数据。

		腾讯的服务器没有邮件服务，
	所以腾讯三国的日报将数据统计好后写在文件里即可，运维那边会把这部分数据在经过脚本发出去。

		新的游戏需要加日报时，如果不需要额外的处理，只需要在from_email_list和subject_list数组中按照格式增加相应的信息，
	发件邮箱使用同平台下的游戏的邮箱即可，如game168平台下的游戏使用cs@game168.com.tw。
	没有日志库的游戏因为不会统计留存、等级趋势、登录数据，所以在统计这几个数据的过程中将其排除即可(将当前游戏game_id加到两处的数组中)。
	然后让运维跑一下脚本进行测试，测试通过后让运维将该游戏的脚本命令加到定时执行列表中每天自动去跑。

		有时候有些游戏会不再需要发送日报，这时可以在在脚本运行的时候直接return掉即可（将游戏game_id加入要排除的数组中）。

	2）德州扑克额外的日报脚本PokerDataDaily
		这个是德扑自己额外的一个脚本，不会经常去增加新游戏的日报，可能有时候会改一些需求，所以这个就不多做说明了

	3）储值储值失败订单报警邮件RechargeFailAlert
		每个10分钟，该脚本都会跑一遍，循环检查每个游戏在上个整10分到现在产生的订单中，
	订单状态为 get_payment=1 and offer_yuanbao=0 的订单，查询这些订单的相关信息以邮件的新式发送给相关人员。
		同时，将查到的订单信息再经过处理存入eastblue库的record_orders表中，在其他功能中会用到这部分数据。

	需要注意的地方：某些游戏由于某种东西（一般是礼包）价格比较高，但是由于受档位所限，玩家一次买不了这个礼包，于是玩家需要下几次订单一起实现买这个礼包。
	这种订单在pay_order表中的combined_orders字段是一个json字符串，存着相关订单的所有订单号，并且giftbag_id字段存着要购买的礼包id。
	所以遇到这种合并订单时需要判断对应的所有先关的订单的支付金额之和是否大于对应的礼包价格，如果大于礼包价格则对该订单进行处理，否则直接跳过该订单。

	4）元宝监控脚本MasterMonitor
		统计一段时间之内通过运营后台的操作（修改元宝、邮件礼包）玩家获得的元宝和玩家充值的元宝，
	如果玩家获得的元宝比充值元宝多出一定的值后，则过滤掉内玩玩家后将这些玩家的数据以报警邮件的形式告知先关人员。
		修改元宝功能增加的元宝在eastblue数据库log表下有记录，log_key字段页游为changeYuanbao，
	手游为mobilechangeYuanbao的表示是修改元宝功能操作的记录。desc字段以“|”分隔信息，以"|"拆分成数组后有5个元素的为标准的形式，
	如 1000001|T1 白胡子|增加|100|元宝 表示增加给 T1 白胡子 伺服器的 1000001玩家增加100元宝，只有这种形式的数据是我们要统计的。
		通过礼包邮件功能修改的元宝存在eastblue库operations表中，operation_type字段为mail_gift是礼包邮件操作的记录，success|id|数量:1000
	和修改元宝功能记录的数据类似，



3：统计数据并存入数据库中的脚本
	1）留存计算脚本
		涉及到两个脚本AnalyzeAllRetentionIntoDB和AnalyzeRetentionIntoDB，
	AnalyzeAllRetentionIntoDB脚本和ImportLogDataIntoDB的功能一样，服务器会在每天凌晨去执行这个脚本，
	然后这个脚本循环当前平台下的游戏服务器去调用AnalyzeRetentionIntoDB脚本计算留存。
	计算的过程中页游和手游会有些差别，页游需要安匿名和非匿名分别统计留存，手游则不需要区分，还有手游会比页游多算一个30天留存。
	没有日志数据的游戏是不需要计算留存的，可以在AnalyzeAllRetentionIntoDB脚本中将这类游戏排除掉。

	2)手游渠道留存脚本AnalyzeChannelRetentionIntoDB
		和留存脚本类似，该脚本是计算每个channel_list表中每个channel的留存

	3)渠道留存脚本AnalyzeUserRetentionIntoDB
		和留存脚本类似，该脚本是计算是计算每组source、u、u1、os_type的留存，手游页游都区分匿名和非匿名。

4：夜夜三国和学妹导入游戏后台日志库数据脚本
		和页游不同，手游的经济日志、角色信息日志等数据不是通过游戏日志服务器打印日志文件到我们的slave端，
	而是我们直接从游戏后台日志库读取数据导入到我们的日志库中。
		所有表都使用主键id作为上次导入位置的标记，每次取符合条件的最多1000条数据导入。
	其中经济日志log_economy表为了查询方便也是要计算铜钱元宝等物品的差值，所以需要循环处理这次取到的每条数据计算差值然后在导入。
	学妹的经济日志还有额外的一个表log_economy_new
	
	1）夜夜三国脚本ImportYYSGLogDataIntoDB
		夜夜三国游戏后端日志库目前除了大陆地区以外各地区的每种数据是存在同一张表中，运营后台为了方便查询，
	在导入的时候将数据安地区分别导入到不同地区的日志库中。区分不同地区数据的方法是log_ecrate_player表可以通过platform_id直接判断每条数据分属于那个地区，
	其他表则通过连接log_create_player表区分数据属于那个地区。
		增加了新游戏需要导入日志库数据时，如果游戏后端日志库还是使用以前的日志库，则让运维在该地区机器上增加该脚本的定时执行任务YYSGlog:import game_id，然后在game_cofig配置文件下加入该游戏即可。

	2）学妹用到两个脚本分别是ImportMNSGDataIntoDB和ImportMNSGLogDataIntoDB
		ImportMNSGDataIntoDB相当于页游ImportLogDataIntoDB脚本，会在每个整10分去循环每个服调用ImportMNSGLogDataIntoDB脚本导入数据。
	学妹游戏后端的的日志库各地区是分开的，但是学妹是衮服，所以导入的时候需要将不同服务器的数据分开导入到日志库。区分不同服务器的数据是通过player_id的值判断，
	每个服务器的玩家id都是以服务器的server_internal_id开头，如果player_id在集合（server_internal_id*100000，server_internal_id + 1)*100000）中，则该玩家属于该服务器。
		因为学妹游戏后端的的日志库各地区是分开的，所以当新增加游戏后需要导入日志库数据时需要找运维配置数据库配置。在game_cofig配置文件下加入该游戏，然后让运维在该地区增加脚本调用任务，。

5：导入游戏中在线人数的脚本
	每个整10分通过调用游戏API查询每个伺服器当前在线人数然后插入日志库log_online表，时间online_time插入时间精确到整10分。
	1）风流三国、女神之剑、大乱斗、德州扑克使用CountOnlineIntoDB。德扑只有一个服务器，
	其他游戏需要查询取当前游戏的所有主服然后去循环查询在线人数。
		注意点：德扑查询时，发给游戏端的参数是date('Y-m-d', time())，游戏端会返回这一天的每个整10分的在线人数，目前是按照时间降序排序后取前5条跟新或插入日志库。
			页游是循环查出当前游戏所有主服的在线人数后存入数组中然后统一发到slave端，然后在将数据分别存入到对应的日志库表中。在插入的过程不要每个库都连接一次数据库，只需连接一次数据库即可，否则可能会导致eastblue数据库连接数超过最大配置连接数。

	2）学妹使用MobileGameOnline脚本
		和页游类似，只是学妹目前不是通过查询所有服再统一发到slave在插入数据的，而是差一个服插入一个服的数据。为了防止 1）中说的数据库连接数查过最大配置，后面这个也应该改成 1）中的那种方式。

6：开服脚本OpenServerCommand
		运营在运营后台创建服务器的时候都会设置一个开服时间，然后在服务器设定的开启快要到的时候，使用定时脚本去开启官网的游戏服务器。
	开服脚本每个整半小时会执行一次，从servers表中取出设定的开服时间在未来一个小时以内的没有开启的服务器。有些游戏的服务器在开服前需要重置，
	所以需要先去调用游戏API重置服务器的接口重置服务器，接着将运营平台游戏的状态修改为开启状态，
	然后再去调官网开服的接口开启官网的游戏服务器和官网的支付服务器，不管开启有没有成功，都会发一份邮件通知运营。
		除了开启服务器还有另外一件事情需要开服脚本取做，就是关掉创建服务器的时候有设置开启了月卡的服务器的月卡。



7：页游定时开活动脚本
		由于转盘活动当开启一个活动之后比如这个活动在今天晚上11点结束，运营想在开一个明天要开启的转盘活动，
	但是由于第一个转盘活动还没有结束，转盘活动会开启不成功，运营必须等到今天晚上11点之后才能开启下一个转盘类活动。
	而对于假日活动中，有几个活动也存在类似的问题，比如开启了一个累积储值活动在今晚11点结束，
	如果想在开启一个明天的累积储值活动也是要等到第一个活动结束之后才能开启成功。
		而本脚本就是为了能够提前让运营设置一个活动，但是却不会马上去调游戏API去开启活动，
	而是将运营要开的活动信息存在eastblue数据库的timing_activities表中，
	然后在这个活动开始时间即将要到的时候通过这个脚本将开活动的信息发给游戏服务器，然后去开启活动。
		这个脚本实际的用处就是没必要让运营等到上一个活动结束之后再去开启活动，
	因为有时候上一个活动可能会在北京时间的凌晨结束。

		目前的逻辑主要是运营通过定时开启的方式开启活动之后，运营后台不会马上去将这部分参数发送给游戏服务器，
	而是通过将参数组装好之后存入数据库。然后每个整10分都会跑一次这个脚本，检查活动的开始时间有没有大于当前时间且小于下一个整10分且还没有开启的活动，
	如果有则会去尝试开启每个这种活动。如果开启成功，则将活动状态跟新为已开启成功的状态，并发一份邮件给运营。
	如果没有开启成功，则状态不会改，程序会在sleep一段合适的时间后再去尝试开启它，直到已经过了活动的开始时间如果还没有开启成功，
	则示本活动没有开启成功，这时也需要发一份邮件告诉运营。如果只有部分服开启失败，那么将这部分服的数据取出来重新插入一条数据当成是新的一次开活动数据取处理。



 





